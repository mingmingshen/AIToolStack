services:
  camthink:
    image: camthink/aitoolstack:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: camthink-aitoolstack
    ports:
      # Format: host_ip:host_port:container_port
      # Use 0.0.0.0 to bind all network interfaces, allowing external access
      - "0.0.0.0:8000:8000"  # Web service port
      - "0.0.0.0:1883:1883"  # MQTT port
    volumes:
      # Data persistence
      - ./datasets:/app/datasets
      - ./data:/app/data
      - backend-data:/app/backend/data
      # NE301 project directory (auto-initialized)
      # Container will automatically detect on startup: if host directory is empty, auto-clone; otherwise use existing content
      # Docker-in-Docker compilation requires host path, so mounting is required (auto-initialized)
      # Note: On first run, will automatically clone to ./ne301, no manual operation needed
      - ./ne301:/workspace/ne301  # Host directory, auto-cloned on container startup (if empty)
      # Docker socket (for running Docker commands inside container to compile NE301 models)
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=False
      # MQTT configuration
      - MQTT_ENABLED=true
      - MQTT_USE_BUILTIN_BROKER=true
      - MQTT_PORT=1883
      - MQTT_BUILTIN_PORT=1883
      # MQTT Broker external address (recommended to set to server's real IP address)
      # If not set, system will try to auto-detect, but may be inaccurate in Docker environment
      - MQTT_BROKER_HOST=192.168.110.105
      # Database configuration
      - DATABASE_URL=sqlite:////app/backend/data/annotator.db
      # File storage configuration
      - DATASETS_ROOT=/app/datasets
      # NE301 model compilation configuration
      # NE301_PROJECT_PATH: Use workspace mount path (host directory mapping, auto-initialized on container startup)
      - NE301_PROJECT_PATH=/workspace/ne301
      # CONTAINER_NAME: Docker-in-Docker requires container name to dynamically get host path (auto-detected, paths differ on different machines)
      - CONTAINER_NAME=camthink-aitoolstack
      # NE301_HOST_PATH: Optional, only used when auto-detection fails (not recommended to set manually)
      # Auto-detection will try: 1) docker inspect to find /workspace/ne301 mount point, 2) infer project root from datasets mount point
      # Normally this variable doesn't need to be set, system will auto-detect
      # - NE301_HOST_PATH=/path/to/project/ne301
      - NE301_USE_DOCKER=true
      - NE301_DOCKER_IMAGE=camthink/ne301-dev:latest
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  backend-data:
